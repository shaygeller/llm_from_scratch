# Product Requirement Document: Phase 2 - SFT & Agent Reasoning

## 1. Objective

Transform the base predictor into a Reasoning Agent that can "think" before answering and reliably execute external code tools.

## 2. Technical Specifications

### 2.1 The "ReAct" Data Mixture

**Composition:**
- **50% General Chat:** (Fluency)
- **25% CoT Math:** (Logic)
- **25% Tool Use:** (Action)

**Why this mix?** If we train only on Tools, the model forgets how to chitchat. If we train only on Math, it becomes dry/robotic. This balance maintains versatility.

### 2.2 Formatting & Masking (Crucial)

**Format:**
```
<|im_start|>user
Calculate 25 * 48.<|im_end|>
<|im_start|>model
<|start_thought|>
Break it down: 25 * 4 = 100. 48 / 4 = 12. So 100 * 12...
<|end_thought|>
The answer is 1200.<|im_end|>
```

**Loss Masking:**
- **Strategy:** Calculate loss only on tokens generated by the Assistant.
- **Why?** If we train on User tokens, the model learns to predict questions (e.g., seeing "What is" and predicting "the capital of France"). We want it to answer questions, not autocomplete them.

## 3. Inference Strategy (Small Model Guardrails)

### 3.1 Grammar-Constrained Decoding

**Problem:** 1B models are prone to "syntax hallucination" (e.g., missing a comma in JSON, using single quotes instead of double).

**Solution:** Finite State Machine (FSM) masking via `outlines`.

When `<|tool_call|>` is triggered, the sampler is restricted to only output tokens that fit the regex: `\{ "function": "\w+", "arguments": \{.*\} \}`.

**Why?** This guarantees 100% syntactically valid JSON, shifting the failure mode from "Parse Error" to "Wrong Argument," which is easier to debug.

### 3.2 The Agent Loop

**Flow:** Thought → Tool Call → (Python Execution) → Tool Response → Final Answer

**Why Thoughts?** "Chain of Thought" acts as a computation buffer. It allows the model to "dump" intermediate variables into the context window before committing to a final action. Without it, the model must solve the problem in a single forward pass, which is often impossible for complex queries.